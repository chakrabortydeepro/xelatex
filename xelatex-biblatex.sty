% Biblatex:
\usepackage[%
backend=biber,
%style=authoryear-icomp,
% Make idem and ibidem behave appropriately:
%https://tex.stackexchange.com/questions/61717/biblatex-strictly-identical-footnote-citations-following-each-other
% (and see \newbibmacro*{cite:ibid} below).
%ibidpage,
%idemtracker=false,
%style=authoryear,
%uniquename=false,
% oxref:
style=oxyear,
dashed=true,
% end oxref
%bibstyle=publist,
%marginyear=true,
%style=verbose-trad1,
%
% I finally worked out how to sort cites by year and bibliography by name
% https://cikitsa.blogspot.ca/2017/07/biblatex-citations-and-bibliography.html
sorting=ynt,  %ynt for the citations in date order; nyt otherwise
sortcites=true, 
%sortlocale=en-GB,
backref=false,
date=comp,
datecirca=true,
dateuncertain=true,
bibencoding=auto,
hyperref=auto,
isbn=true,
doi=true,
language=auto,
natbib=true,
texencoding=auto,
url=true,
urldate=short,
usetranslator=true,
useprefix=true,% van Nooten
giveninits=false,
%refsection=section,
%bibstyle=manuscripts, % invokes biblatex-manuscripts-philology
]{biblatex}

\ExecuteBibliographyOptions[% for biblatex-oxyear
article,
book,
mvbook,
mvcollection,
inbook,
incollection,
inreference,
collection,
reference,
mvreference]{useeditor=true,
    usetranslator=true,
%    uniquename=full
}

%%% patch of Sept 2019 
%%%https://mail.google.com/mail/u/0/#inbox/FMfcgxwDrHpMnGSkkqjMqHwCCdJqBLkC
%%%\makeatletter
%%\xpatchbibmacro{bookeditor}{\global\undef\bbx@lasthash}{}{}{%
%%    \wlog{INFO: oxyear fix no longer needed!}}
%%%\makeatother

% I finally discovered how to sort citations by year and bibliography entries by name
% (and see sorting, above).
% https://cikitsa.blogspot.ca/2017/07/biblatex-citations-and-bibliography.html
\AtBeginDocument{\assignrefcontextentries[]{*}}  
% But this isn't working 2021-05 :-(

% To avoid saying \newrefcontext[sorting=nyt] before \printbibliography in every 
%document redefine \printbibliography (from biblatex.sty):

\renewrobustcmd*{\printbibliography}{%
 \newrefcontext[sorting=nyt] % added this line
    \begingroup
    \delimcontext{bib}%
    \edef\on@line{\on@line}%
    \@ifnextchar[%]
    {\blx@printbibliography}
    {\blx@printbibliography[]}}

%\addbibresource
%%[datatype=bibtex]
%{biblio4-utf8.bib}

% biblatex documentation 4.11.2 and macros from biblatex.def
% Enable hot URLs for PDFs at Archive.org and Academia.edu 
\newif\ifBibHiddenURLs
 %
\ifBibHiddenURLs 
   \relax
\else
%
\DeclareFieldFormat{url}{%
    \ifhyperref
    {\textsc{url: }\href{#1}{#1}}
    {\textsc{url: }\nolinkurl{#1}}} %DW bug here
%
% Buddhist Digital Resource Center:
\DeclareFieldFormat{eprint:tbrc}{%
    \textsc{TBRC}\space
    \ifhyperref  
    {\href{https://www.tbrc.org/\#!rid=#1}{\nolinkurl{#1}}}
    {\nolinkurl{#1}}}
%
\DeclareFieldFormat{eprint:ark}{%
	\textsc{ark:}\space
	\ifhyperref  
	{\href{https://n2t.net/#1}{\nolinkurl{#1}}}
	{\nolinkurl{#1}}}
%
\DeclareFieldFormat{eprint:archive}{%
%    Internet Archive\addcolon\space
    \ifhyperref
%    {\href{http://archive.org/details/#1}{\nolinkurl{#1}}}
    {\href{http://archive.org/details/#1}{{\small Internet Archive}}}
    {\nolinkurl{#1}}}
\DeclareFieldAlias{eprint:archive.org}{eprint:archive}
\DeclareFieldAlias{eprint:Archive.org}{eprint:archive}

\DeclareFieldFormat{eprint:academia}{%
%    Academia.edu\addcolon\space
    \ifhyperref
    {\href{http://www.academia.edu/#1}{{\small Academia.edu}}}
    {\nolinkurl{#1}}}
\DeclareFieldAlias{eprint:academia.edu}{eprint:academia}

\DeclareFieldFormat{eprint:dli}{%
%    DLI\addcolon\space
    \ifhyperref
    {\href{http://www.dli.gov.in/cgi-bin/DBscripts/allmetainfo.cgi?barcode=#1/}{{\small 
    Digital Library of India}}}
    {\nolinkurl{#1}}}
\DeclareFieldAlias{eprint:DLI}{eprint:dli}
\DeclareFieldFormat{eprint:jstor}{%
    \ifhyperref
    {\href{http://www.jstor.org/stable/#1}{{\small JSTOR}}}
    {\nolinkurl{#1}}}

\DeclareFieldFormat{eprint:google}{%
    \ifhyperref
    {\href{http://books.google.com/books?id=#1}{{\small Google books}}}
    {\nolinkurl{#1}}} 
%
\DeclareFieldFormat{doi}{%
    \textsc{doi}\addcolon\space
    \ifhyperref
    {\href{https://doi.org/#1}{\nolinkurl{#1}}}
    {\nolinkurl{#1}}}
%
\fi
\BibHiddenURLsfalse

\defcitealias{meul-hist}{HIML}
\defcitealias{ncc}{NCC}
\defcitealias{bisw-bibl}{BSIMC}

% to make bibtex notes print last, like addendums
% from http://tex.stackexchange.com/
%questions/138913/
%how-to-move-the-field-note-at-the-end-of-the-reference
\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldsource=note, final]
            \step[fieldset=addendum, origfieldval, final]
            \step[fieldset=note, null]
        }
    }
}
%tweaks to make the citation form:-  Author date: page
\DeclareFieldFormat{postnote}{#1}
\renewcommand{\postnotedelim}{:\,}
\renewcommand{\nameyeardelim}{ }

% suppress shorthands: http://tex.stackexchange.com/questions/57041/
%\AtEveryCitekey{\clearfield{shorthand}}

\usepackage{csquotes}

% Biblatex hacks to get pubstate (?forthcoming? etc.) behaving as it should
% Biblatex manual 4.5.10
\DeclareLabeldate{%
	\field{date}
	\field{year}
	\field{pubstate}
    \field{eventdate}
    \field{origdate}
    \field{urldate}
    \literal{nodate}
}


% Some magic from “moewe” at 
%https://tex.stackexchange.com/questions/442749/biblatex-have-hyperref-links-point-to-the-shorthand-list
% that makes hyperlinks work from citations to a list of abbreviations.
\DeclareFieldFormat{shorthandwidth}{%
    \bibhypertarget{shorthand:\thefield{entrykey}}
    {#1}}

\DeclareFieldFormat{bibhyperref}{%
    \iffieldundef{shorthand}
    {\bibhyperref{#1}}
    {\bibhyperlink{shorthand:\thefield{entrykey}}{#1}}}

%% penalty settings to make URLs format better.  From xurl documentation:
%\usepackage{xurl}
%\setcounter{biburllcpenalty}{1}
%\setcounter{biburlucpenalty}{1}
%\setcounter{biburlnumpenalty}{1}
%% but biblatex has this built in to it.

\endinput

%% redefinition from  bbx/standard.bbx to stop pubstate printing after an addendum
%\renewbibmacro*{addendum+pubstate}{%
%	\printfield{addendum}%
% %		\newunit\newblock 
% %		\printfield{pubstate} 
%}

% 
%https://tex.stackexchange.com/questions/384172/bibliography-entries-with-pubstate-and-no-date-in-authortitle-style
%\renewbibmacro*{date}{%
%    \ifboolexpr{ test {\iffieldundef{year}} and not test {\iffieldundef{pubstate}} }%
%    {\printfield{pubstate}}%
%    {\printdate}}
%
%\renewbibmacro*{addendum+pubstate}{%
%    \printfield{addendum}%
%    \newunit\newblock
%    \iffieldundef{year}
%    {}
%    {\printfield{pubstate}}}

%% Make idem and ibidem behave appropriately:
%%https://tex.stackexchange.com/questions/61717/biblatex-strictly-identical-footnote-citations-following-each-other
%\renewbibmacro*{cite:ibid}{%
%    \printtext{%
%        \bibhyperlink{cite\csuse{cbx@lastcite@\thefield{entrykey}}}{%
%            \ifloccit
%            {\bibstring[\mkibid]{ibidem}%
%                \global\toggletrue{cbx:loccit}}
%            {\bibstring[\mkibid]{idem\thefield{gender}}}}}}
% I gave up on the idem/ibid stuff.
