% \section{Bib\LaTeX\ }
%    \begin{macro}{BibLaTeX}
%  Load the Bib\LaTeX\ package and
% the \verb|oxyear| style, and set the various options.
%    \begin{macrocode}
\usepackage[%
backend=biber,
%style=authoryear-icomp,
% Make idem and ibidem behave appropriately:
%\url{https://tex.stackexchange.com/questions/61717/biblatex-strictly-identical-footnote-citations-following-each-other}
% (and see \newbibmacro*{cite:ibid} below).
%ibidpage,
%idemtracker=false,
%style=authoryear,
%uniquename=false,
% oxref:
style=oxyear,
dashed=true,
% end oxref
%bibstyle=publist,
%marginyear=true,
%style=verbose-trad1,
%
% I finally worked out how to sort cites by year and bibliography by name
% 
%\url{https://cikitsa.blogspot.ca/2017/07/biblatex-citations-and-bibliography.html}
sorting=ynt,  %ynt for the citations in date order; nyt otherwise
sortcites=true, 
%sortlocale=en-GB,
backref=false,
date=comp,
datecirca=true,
dateuncertain=true,
bibencoding=auto,
hyperref=auto,
isbn=true,
doi=true,
language=auto,
natbib=true,
texencoding=auto,
url=true,
urldate=short,
usetranslator=true,
useprefix=true,% van Nooten
giveninits=false, % Give first names in the bibliography.  See 
%\url{https://github.com/alex-ball/biblatex-oxref/issues/17#issuecomment-843383550}
%maxnames=1, % before “et al.”
%uniquelist=false,
%refsection=section,
%bibstyle=manuscripts, % invokes biblatex-manuscripts-philology
]{biblatex}

\ExecuteBibliographyOptions[% for biblatex-oxyear
article,
book,
mvbook,
mvcollection,
inbook,
incollection,
inreference,
collection,
reference,
mvreference]{useeditor=true,
    usetranslator=true,
%    uniquename=full
}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{compyear}
% Patch so that date-abbreviations aren't just one digit.
% Kindly supplied by Alex Ball, 
%\url{https://github.com/alex-ball/biblatex-oxref/issues/19}
%    \begin{macrocode}
\renewcommand{\blx@ox@compyear}[2]{%
    \def\num@one{#1}%
    \def\num@two{#2}%
    \StrLen{\num@one}[\num@one@len]%
    \StrLen{\num@two}[\num@two@len]%
    \ifboolexpr{
        test {\ifnumequal{\num@one@len}{\num@two@len}}
        and
        test {\ifnumless{\num@one}{\num@two}}
    }{%
        \StrCompare{\num@one}{\num@two}[\Result]%
        \ifnum\num@two@len>3%
        \IfStrEq{\Result}{2}{\def\Result{1}}{}%
        \fi
        %%% Extend the legal date compression behaviour to all entries
        \IfStrEq{\Result}{4}{\def\Result{3}}{}%
        %%% End of changes
        \StrGobbleLeft{0\num@two}{\Result}%
    }{\num@two}}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{bookeditor}
%  I don't use this, now.
%  patch of Sept 2019 
% 
%\url{https://mail.google.com/mail/u/0/#inbox/FMfcgxwDrHpMnGSkkqjMqHwCCdJqBLkC}
%    \begin{macrocode}
%\makeatletter
%\xpatchbibmacro{bookeditor}{\global\undef\bbx@lasthash}{}{}{%
%    \wlog{INFO: oxyear fix no longer needed!}}
%\makeatother
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{assignrefcontextentries}
% I finally discovered how to sort citations by year and bibliography entries by name
% (and see sorting, above).
% 
%\url{https://cikitsa.blogspot.ca/2017/07/biblatex-citations-and-bibliography.html}
%    \begin{macrocode}
\AtBeginDocument{\assignrefcontextentries[]{*}}  
%    \end{macrocode}
% But this isn't working 2021-05 :-(
%    \end{macro}
%
%    \begin{macro}{comma}
% Following sections 3.10 and 4.7.5 of the Bib\LaTeX\ manual, 
% put the comma \emph{inside} the quotation marks of the title.
%    \begin{macrocode}
\DefineBibliographyExtras{british}{\DeclareQuotePunctuation{.,}}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{printbibliography}
% To avoid saying \verb|\newrefcontext[sorting=nyt]| before
% \verb|\printbibliography| in every 
% document redefine \verb|\printbibliography| (from biblatex.sty):
%    \begin{macrocode}
\renewrobustcmd*{\printbibliography}{%
 \newrefcontext[sorting=nyt] % added this line
    \begingroup
    \delimcontext{bib}%
    \edef\on@line{\on@line}%
    \@ifnextchar[%]
    {\blx@printbibliography}
    {\blx@printbibliography[]}}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{volcite}
% no ``p.'' or ``pp." in, for example, \verb|\volcite|:
%    \begin{macrocode}
\DefineBibliographyStrings{english}{%
    page             = {},
    pages            = {},
    volume     		= {},
} 
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{addbibresource}
%  This isn't used, because we load different bibliographies in different
% documents.
%    \begin{macrocode}
% \addbibresource
%% [datatype=bibtex]
% {biblio4-utf8.bib}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{urls}
% biblatex documentation 4.11.2 and macros from biblatex.def
% Enable hot URLs for PDFs at Archive.org and Academia.edu 
%    \begin{macrocode}
\newif\ifBibHiddenURLs
 %
\ifBibHiddenURLs 
   \relax
\else
%
\DeclareFieldFormat{url}{%
    \ifhyperref
    {\\ \textsc{url: }\href{#1}{#1}} % added a newline to help with long URLs in PDFs
    {\textsc{url: }\nolinkurl{#1}}} %DW bug here
%
% Buddhist Digital Resource Center:
\DeclareFieldFormat{eprint:tbrc}{%
    \textsc{TBRC}\space
    \ifhyperref  
    {\href{https://www.tbrc.org/\#!rid=#1}{\nolinkurl{#1}}}
    {\nolinkurl{#1}}}
%
\DeclareFieldFormat{eprint:ark}{%
	\textsc{ark:}\space
	\ifhyperref  
	{\href{https://n2t.net/#1}{\nolinkurl{#1}}}
	{\nolinkurl{#1}}}
%
\DeclareFieldFormat{eprint:archive}{%
%    Internet Archive\addcolon\space
    \ifhyperref
%    {\href{http://archive.org/details/#1}{\nolinkurl{#1}}}
    {\href{http://archive.org/details/#1}{{\small Internet Archive}}}
    {\nolinkurl{#1}}}
\DeclareFieldAlias{eprint:archive.org}{eprint:archive}
\DeclareFieldAlias{eprint:Archive.org}{eprint:archive}

\DeclareFieldFormat{eprint:academia}{%
%    Academia.edu\addcolon\space
    \ifhyperref
    {\href{http://www.academia.edu/#1}{{\small Academia.edu}}}
    {\nolinkurl{#1}}}
\DeclareFieldAlias{eprint:academia.edu}{eprint:academia}

\DeclareFieldFormat{eprint:dli}{%
%    DLI\addcolon\space
    \ifhyperref
    {\href{http://www.dli.gov.in/cgi-bin/DBscripts/allmetainfo.cgi?barcode=#1/}{{\small 
    Digital Library of India}}}
    {\nolinkurl{#1}}}
\DeclareFieldAlias{eprint:DLI}{eprint:dli}
\DeclareFieldFormat{eprint:jstor}{%
    \ifhyperref
    {\href{http://www.jstor.org/stable/#1}{{\small JSTOR}}}
    {\nolinkurl{#1}}}

\DeclareFieldFormat{eprint:google}{%
    \ifhyperref
    {\href{http://books.google.com/books?id=#1}{{\small Google books}}}
    {\nolinkurl{#1}}} 
%
\DeclareFieldFormat{doi}{%
    \textsc{doi}\addcolon\space
    \ifhyperref
    {\href{https://doi.org/#1}{\nolinkurl{#1}}}
    {\nolinkurl{#1}}}
%
\fi
\BibHiddenURLsfalse
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{citealias}
%  Not used.  Better done in individual documents.
%    \begin{macrocode}
%\defcitealias{meul-hist}{HIML}
%\defcitealias{ncc}{NCC}
%\defcitealias{bisw-bibl}{BSIMC}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{note}
%  To make Bib\LaTeX\  notes print last, like addendums
% from 
%\url{http://tex.stackexchange.com/questions/138913/how-to-move-the-field-note-at-the-end-of-the-reference}
%
%    \begin{macrocode}
\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldsource=note, final]
            \step[fieldset=addendum, origfieldval, final]
            \step[fieldset=note, null]
        }
    }
}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{DeclareFieldFormat}
% Tweaks to make the citation form:-  Author date: page
%    \begin{macrocode}
\DeclareFieldFormat{postnote}{#1}
\renewcommand{\postnotedelim}{:\,}
\renewcommand{\nameyeardelim}{ }
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{clearfield}
% Suppress shorthands: \url{http://tex.stackexchange.com/questions/57041/}
% 
% Once again, I don't use this at present.
%    \begin{macrocode}
% \AtEveryCitekey{\clearfield{shorthand}}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{csquotes}
%    \begin{macrocode}
\usepackage{csquotes} 
\setquotestyle{american} % american = double quotes
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{DeclareLabeldate}
%
% Bib\LaTeX\  hacks to get pubstate (?forthcoming? etc.) behaving as it should
% Bib\LaTeX\  manual 4.5.10
%    \begin{macrocode}
\DeclareLabeldate{%
	\field{date}
	\field{year}
	\field{pubstate}
    \field{eventdate}
    \field{origdate}
    \field{urldate}
    \literal{nodate}
}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{shorthandwidth}
%
% Some magic from “moewe” at 
%\url{https://tex.stackexchange.com/questions/442749/biblatex-have-hyperref-links-point-to-the-shorthand-list}
% that makes hyperlinks work from citations to a list of abbreviations.
%    \begin{macrocode}
\DeclareFieldFormat{shorthandwidth}{%
    \bibhypertarget{shorthand:\thefield{entrykey}}
    {#1}}

\DeclareFieldFormat{bibhyperref}{%
    \iffieldundef{shorthand}
    {\bibhyperref{#1}}
    {\bibhyperlink{shorthand:\thefield{entrykey}}{#1}}}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{penalties}
% Penalty settings to make URLs format better.  From xurl documentation.
% 
% Currently not used.
%    \begin{macrocode}
%\usepackage{xurl}
%\setcounter{biburllcpenalty}{1}
%\setcounter{biburlucpenalty}{1}
%\setcounter{biburlnumpenalty}{1}
%% but Bib\LaTeX\  has this built in to it.
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{volcite}
%
% No "pp." or “pages” in \verb|\volcite| etc.
%    \begin{macrocode}
\DefineBibliographyStrings{english}{%
    page             = {},
    pages            = {},
} 
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{literal}
% Create a new data type in bibtex, @literal, which just prints the 
% content of the title field. 
%
% Thanks to emilianoeheyns at 
%\url{https://forums.zotero.org/discussion/110863/biblatex-both-langid-and-language-are-needed}
%    \begin{macrocode}    
\DeclareBibliographyDriver{literal}{%
    \newunit\newblock
    \printfield{title}%
    \finentry}
%    \end{macrocode}
%    \end{macro}
%
%    \begin{macro}{DeclareSourcemap}
% It turns out that it's the \verb|langid| field that controls language-switching
% in bibliography entries, not \verb|language|.  Since I've always used
% \verb|language|, this code will just write the content of the \verb|language|
% field to the \verb|langid| field, on the fly.
%    \begin{macrocode}
\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldsource=lanuage,fieldtarget=langid]
        }
    }
}
%    \end{macrocode}
%    \end{macro}
%  That's all, folks!
%    
\endinput

% \section{Some alternate ways of dealing with the shorthands}

%        \name{sortname}\name{author}\name{editor}\name{translator}
%        \field{sorttitle}\field{title}}
%    \sort{\field{sortyear}\field{year}}
%    \sort{\field{sorttitle}\field{title}}
%    \sort{%
%        \field[padside=left,padwidth=4,padchar=0]{volume}
%        \literal{0000}}}

% Make a list of Abbreviations using shorttitles and that refer to main entries    
\DeclareBibliographyDriver{shorthand}{%
%\printfield{shorttitle}%
\citetitle{\thefield{entrykey}}\newunit\newblock 
\citeauthor{\thefield{entrykey}}\newunit\newblock
\citeyear{\thefield{entrykey}}
}

% \section{Pubstate tweaks}

%% redefinition from  bbx/standard.bbx to stop pubstate printing after an addendum
%\renewbibmacro*{addendum+pubstate}{%
%	\printfield{addendum}%
% %		\newunit\newblock 
% %		\printfield{pubstate} 
%}

% 
%https://tex.stackexchange.com/questions/384172/bibliography-entries-with-pubstate-and-no-date-in-authortitle-style
%\renewbibmacro*{date}{%
%    \ifboolexpr{ test {\iffieldundef{year}} and not test {\iffieldundef{pubstate}} }%
%    {\printfield{pubstate}}%
%    {\printdate}}
%
%\renewbibmacro*{addendum+pubstate}{%
%    \printfield{addendum}%
%    \newunit\newblock
%    \iffieldundef{year}
%    {}
%    {\printfield{pubstate}}}

%% Make idem and ibidem behave appropriately:
%%https://tex.stackexchange.com/questions/61717/biblatex-strictly-identical-footnote-citations-following-each-other
%\renewbibmacro*{cite:ibid}{%
%    \printtext{%
%        \bibhyperlink{cite\csuse{cbx@lastcite@\thefield{entrykey}}}{%
%            \ifloccit
%            {\bibstring[\mkibid]{ibidem}%
%                \global\toggletrue{cbx:loccit}}
%            {\bibstring[\mkibid]{idem\thefield{gender}}}}}}
% I gave up on the idem/ibid stuff.
